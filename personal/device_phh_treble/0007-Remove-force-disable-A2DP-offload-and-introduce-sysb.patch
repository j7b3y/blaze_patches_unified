From 2408a896b444838c1c414a6e6e3cd7d237517149 Mon Sep 17 00:00:00 2001
From: j7b3y <Glowing3386@proton.me>
Date: Wed, 22 Feb 2023 15:29:45 +0900
Subject: [PATCH 07/10] Remove force disable A2DP offload and introduce sysbta
 HAL

---
 phh-prop-handler.sh | 18 ++++++++++++++++++
 vndk.rc             | 10 ++--------
 2 files changed, 20 insertions(+), 8 deletions(-)

diff --git a/phh-prop-handler.sh b/phh-prop-handler.sh
index 4371632..63f3a78 100644
--- a/phh-prop-handler.sh
+++ b/phh-prop-handler.sh
@@ -124,6 +124,24 @@ if [ "$1" == "persist.sys.phh.disable_audio_effects" ];then
     exit
 fi
 
+if [ "$1" == "persist.bluetooth.system_audio_hal.enabled" ]; then
+    if [[ "$prop_value" != "0" && "$prop_value" != "1" ]]; then
+        exit 1
+    fi
+
+    if [[ "$prop_value" == 1 ]]; then
+        setprop persist.bluetooth.bluetooth_audio_hal.disabled false
+        setprop persist.bluetooth.a2dp_offload.disabled true
+        resetprop_phh ro.bluetooth.a2dp_offload.supported false
+    else
+        resetprop_phh --delete persist.bluetooth.bluetooth_audio_hal.disabled
+        resetprop_phh --delete persist.bluetooth.a2dp_offload.disabled
+        resetprop_phh --delete ro.bluetooth.a2dp_offload.supported
+    fi
+    restartAudio
+    exit
+fi
+
 if [ "$1" == "persist.sys.phh.caf.audio_policy" ];then
     if [[ "$prop_value" != "0" && "$prop_value" != "1" ]]; then
         exit 1
diff --git a/vndk.rc b/vndk.rc
index d1fffde..7f96b52 100644
--- a/vndk.rc
+++ b/vndk.rc
@@ -52,14 +52,8 @@ on property:persist.sys.phh.disable_soundvolume_effect=*
 on property:ro.sf.lcd_density=*
     restart surfaceflinger
 
-on property:persist.sys.phh.disable_a2dp_offload=0
-    setprop persist.sys.phh.disable_a2dp_offload false
-
-on property:persist.sys.phh.disable_a2dp_offload=1
-    setprop persist.sys.phh.disable_a2dp_offload true
-
-on property:persist.sys.phh.disable_a2dp_offload=*
-    setprop persist.bluetooth.bluetooth_audio_hal.disabled ${persist.sys.phh.disable_a2dp_offload}
+on property:persist.bluetooth.system_audio_hal.enabled=*
+    exec u:r:phhsu_daemon:s0 root -- /system/bin/phh-prop-handler.sh "persist.bluetooth.system_audio_hal.enabled"
 
 on property:init.svc.ril-proxy=stopped && property:persist.sys.phh.restart_ril=true
     start ril-proxy
-- 
2.34.1

