From 59a75a4ae030b54fddd7508c83ca2f0db7b853df Mon Sep 17 00:00:00 2001
From: j7b3y <Glowing3386@proton.me>
Date: Wed, 17 Aug 2022 10:25:57 +0900
Subject: [PATCH 2/4] Only use meizu-vibrator on Meizu 18

---
 framework_manifest.xml                                |  9 ---------
 hal/meizu-vabrator/Android.bp                         |  1 +
 .../android.hardware.vibrator@1.3-service.meizu.xml   | 11 +++++++++++
 hal/meizu-vabrator/manifest_dummy.xml                 |  3 +++
 rw-system.sh                                          |  6 ++++++
 5 files changed, 21 insertions(+), 9 deletions(-)
 create mode 100644 hal/meizu-vabrator/android.hardware.vibrator@1.3-service.meizu.xml
 create mode 100644 hal/meizu-vabrator/manifest_dummy.xml

diff --git a/framework_manifest.xml b/framework_manifest.xml
index 1cda019..cb37b49 100644
--- a/framework_manifest.xml
+++ b/framework_manifest.xml
@@ -19,14 +19,5 @@
             <instance>default</instance>
         </interface>
     </hal>
-    <hal>
-        <name>android.hardware.vibrator</name>
-        <transport>hwbinder</transport>
-        <version>1.3</version>
-        <interface>
-            <name>IVibrator</name>
-            <instance>default</instance>
-        </interface>
-    </hal>
 </manifest>
 
diff --git a/hal/meizu-vabrator/Android.bp b/hal/meizu-vabrator/Android.bp
index 3ac4ca8..7972184 100644
--- a/hal/meizu-vabrator/Android.bp
+++ b/hal/meizu-vabrator/Android.bp
@@ -15,6 +15,7 @@
 cc_binary {
     name: "android.hardware.vibrator@1.3-service.meizu",
     relative_install_path: "hw",
+    vintf_fragments: ["android.hardware.vibrator@1.3-service.meizu.xml", "manifest_dummy.xml"],
     init_rc: ["android.hardware.vibrator@1.3-service.meizu.rc"],
     srcs: ["service.cpp", "Vibrator.cpp"],
     cflags: ["-Wall", "-Werror"],
diff --git a/hal/meizu-vabrator/android.hardware.vibrator@1.3-service.meizu.xml b/hal/meizu-vabrator/android.hardware.vibrator@1.3-service.meizu.xml
new file mode 100644
index 0000000..42bc271
--- /dev/null
+++ b/hal/meizu-vabrator/android.hardware.vibrator@1.3-service.meizu.xml
@@ -0,0 +1,11 @@
+<manifest version="1.0" type="framework">
+    <hal format="hidl">
+        <name>android.hardware.vibrator</name>
+        <transport>hwbinder</transport>
+        <version>1.3</version>
+        <interface>
+            <name>IVibrator</name>
+            <instance>default</instance>
+        </interface>
+    </hal>
+</manifest>
\ No newline at end of file
diff --git a/hal/meizu-vabrator/manifest_dummy.xml b/hal/meizu-vabrator/manifest_dummy.xml
new file mode 100644
index 0000000..62d7de8
--- /dev/null
+++ b/hal/meizu-vabrator/manifest_dummy.xml
@@ -0,0 +1,3 @@
+<!-- Dummy manifest XML -->
+<manifest version="1.0" type="framework">
+</manifest>
\ No newline at end of file
diff --git a/rw-system.sh b/rw-system.sh
index 9f80787..fc17ac4 100644
--- a/rw-system.sh
+++ b/rw-system.sh
@@ -371,6 +371,12 @@ if [ "$foundFingerprint" = false ];then
     mount -o bind system/phh/empty /system/etc/permissions/android.hardware.fingerprint.xml
 fi
 
+if ! getprop ro.vendor.build.fingerprint | grep -qE 'meizu_18'; then
+    mount -o bind system/phh/empty /system/bin/hw/android.hardware.vibrator@1.3-service.meizu
+    mount -o bind system/phh/empty /system/etc/init/android.hardware.vibrator@1.3-service.meizu.rc
+    mount -o bind system/etc/vintf/manifest/manifest_dummy.xml /system/etc/vintf/manifest/android.hardware.vibrator@1.3-service.meizu.xml
+fi
+
 if ! grep android.hardware.bluetooth /vendor/manifest.xml && ! grep android.hardware.bluetooth /vendor/etc/vintf/manifest.xml; then
     mount -o bind system/phh/empty /system/etc/permissions/android.hardware.bluetooth.xml
     mount -o bind system/phh/empty /system/etc/permissions/android.hardware.bluetooth_le.xml
-- 
2.37.1.windows.1

